// ui.min.js — menu mobile, floating buttons, animated CTA, countdown, mini-cart UI
(function(){'use strict';
function $1(s){return document.querySelector(s)}
function $all(s){return document.querySelectorAll(s)}
function onDOM(fn){if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',fn);else fn();}

/* MENU */
function initMenu(){
  var menu = $1('.ml-menu');
  if(!menu) return;
  // toggle button
  var btn = document.createElement('button'); btn.className='ml-menu-toggle'; btn.setAttribute('aria-expanded','false'); btn.setAttribute('aria-label','Abrir menú');
  btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h16M4 18h16" stroke="#111" stroke-width="2" stroke-linecap="round"/></svg>';
  menu.parentNode.insertBefore(btn, menu);
  btn.addEventListener('click', function(e){
    var open = btn.getAttribute('aria-expanded')==='true';
    btn.setAttribute('aria-expanded', (!open).toString());
    menu.classList.toggle('open', !open);
    document.documentElement.classList.toggle('no-scroll', !open);
  });
  // close on outside
  document.addEventListener('click', function(ev){ if(!menu.contains(ev.target) && !btn.contains(ev.target)){ menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); document.documentElement.classList.remove('no-scroll'); }});
}

/* FLOATING UI + CART PANEL */
function createCartPanel(){
  if($1('#ml-cart-panel')) return;
  var panel = document.createElement('aside'); panel.id='ml-cart-panel'; panel.className='ml-cart-panel';
  panel.innerHTML = '<header><strong>Carrito</strong><button id="ml-cart-close" aria-label="Cerrar">✕</button></header><div id="ml-cart-items" class="ml-cart-items"></div><footer><div class="ml-cart-actions"><button id="ml-cart-clear" class="btn-read">Vaciar</button><a id="ml-cart-whatsapp" class="buy-btn" href="#" target="_blank">Enviar por WhatsApp</a></div></footer>';
  document.body.appendChild(panel);
  $1('#ml-cart-close').addEventListener('click', function(){ panel.classList.remove('open'); });
  $1('#ml-cart-clear').addEventListener('click', function(){ localStorage.removeItem('ml_cart_v1'); renderCart(); });
  $1('#ml-cart-whatsapp').addEventListener('click', function(e){
    e.preventDefault();
    var items = JSON.parse(localStorage.getItem('ml_cart_v1')||'[]');
    if(!items.length){ alert('El carrito está vacío'); return; }
    var text = 'Pedido%20desde%20'+encodeURIComponent(location.hostname)+'%0A%0A';
    items.forEach(function(it,i){ text += (i+1)+'.%20'+encodeURIComponent(it.title)+'%20-%20'+encodeURIComponent(it.price||'Consultar')+'%0A'; });
    text += '%0ATotal%20items:%20'+items.length;
    var wa = 'https://wa.me/56953827347?text='+text;
    window.open(wa,'_blank');
  });
}
function renderCart(){
  createCartPanel();
  var panel = $1('#ml-cart-panel'); var list = $1('#ml-cart-items');
  var items = JSON.parse(localStorage.getItem('ml_cart_v1')||'[]');
  if(!list) return;
  if(!items.length){ list.innerHTML = '<p class="empty">Tu carrito está vacío</p>'; $1('#ml-cart-whatsapp').setAttribute('href','#'); return; }
  var html = '<ul>';
  items.forEach(function(it,i){ html += '<li><strong>'+(it.title||'Producto')+'</strong><div class="item-meta"><span class="price">'+(it.price||'Consultar')+'</span><a href="'+(it.url||'#')+'" class="small-link">Ver</a></div></li>'; });
  html += '</ul>';
  list.innerHTML = html;
  // set whatsapp link (same as panel button logic)
  var text = 'Pedido%20desde%20'+encodeURIComponent(location.hostname)+'%0A%0A';
  items.forEach(function(it,i){ text += (i+1)+'.%20'+encodeURIComponent(it.title)+'%20-%20'+encodeURIComponent(it.price||'Consultar')+'%0A'; });
  text += '%0ATotal%20items:%20'+items.length;
  $1('#ml-cart-whatsapp').setAttribute('href','https://wa.me/56953827347?text='+text);
}

/* FLOATING BUTTONS animation + creation */
function initFloatingButtons(){
  // ensure whatsapp float exists
  var wf = $1('#whatsapp-float');
  if(wf){ wf.classList.add('ml-float-entrance'); wf.addEventListener('mouseenter',function(){ wf.classList.add('ml-float-hover'); }); wf.addEventListener('mouseleave',function(){ wf.classList.remove('ml-float-hover'); }); }
  // cart float (if not exists)
  if(!$1('#cart-float')){
    var cf = document.createElement('a'); cf.id='cart-float'; cf.href='#'; cf.title='Ver carrito'; cf.className='ml-float btn-cart'; cf.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M6 6h15l-1.5 9h-11zM6 6L4 2H2" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    document.body.appendChild(cf);
    cf.addEventListener('click', function(e){ e.preventDefault(); createCartPanel(); renderCart(); $1('#ml-cart-panel').classList.toggle('open'); });
  }
}

/* ADD TO CART binding (any button with data-add-to-cart or #add-to-cart) */
function bindAddToCart(){
  var btns = $all('[data-add-to-cart], #add-to-cart');
  Array.prototype.forEach.call(btns, function(b){
    b.addEventListener('click', function(e){
      e.preventDefault();
      var title = document.querySelector('h1[itemprop="name"], h1') ? (document.querySelector('h1[itemprop="name"], h1').innerText) : document.title;
      var priceEl = document.querySelector('.post-full .price-badge');
      var price = priceEl ? priceEl.getAttribute('data-price') || priceEl.innerText : 'Consultar';
      var item = { title: title, price: price, url: location.href };
      var count = (function(){ var arr=JSON.parse(localStorage.getItem('ml_cart_v1')||'[]'); arr.push(item); localStorage.setItem('ml_cart_v1', JSON.stringify(arr)); return arr.length; })();
      // animate cart float (pulse)
      var cf = $1('#cart-float');
      if(cf){ cf.classList.add('pulse'); setTimeout(function(){ cf.classList.remove('pulse'); },800); }
      // update panel if open
      renderCart();
      // small toast
      var t = document.createElement('div'); t.className='ml-toast'; t.textContent='Agregado al carrito ('+count+')'; document.body.appendChild(t); setTimeout(function(){ t.classList.add('visible'); },10); setTimeout(function(){ t.classList.remove('visible'); setTimeout(function(){ t.parentNode.removeChild(t); },300); },1800);
    });
  });
}

/* CTA COUNTDOWN — looks for [data-countdown="2025-12-31T23:59:00Z"] on .buy-btn or .buy-cta */
function initCountdowns(){
  var nodes = $all('[data-countdown]');
  Array.prototype.forEach.call(nodes, function(n){
    var iso = n.getAttribute('data-countdown');
    if(!iso) return;
    try{
      var target = new Date(iso);
      function tick(){
        var diff = Math.max(0, target - new Date());
        var days = Math.floor(diff / 86400000);
        var hours = Math.floor((diff % 86400000) / 3600000);
        var mins = Math.floor((diff % 3600000) / 60000);
        var secs = Math.floor((diff % 60000) / 1000);
        n.setAttribute('data-countdown-remaining', days+'d '+hours+'h '+mins+'m');
        n.querySelectorAll('.countdown-display').forEach(function(d){ d.textContent = days+'d '+hours+'h '+mins+'m '+secs+'s'; });
        if(diff<=0) { n.classList.add('expired'); clearInterval(int); }
      }
      var int = setInterval(tick, 1000); tick();
    }catch(e){}
  });
}

/* INIT */
onDOM(function(){
  document.body.classList.remove('no-js');
  initMenu(); initFloatingButtons(); bindAddToCart(); initCountdowns();
  // small accessibility: escape to close cart panel
  document.addEventListener('keydown', function(e){ if(e.key==='Escape'){ var p=$1('#ml-cart-panel'); if(p) p.classList.remove('open'); } });
  // render cart count (optional)
  var count = (JSON.parse(localStorage.getItem('ml_cart_v1')||'[]')).length;
  var cf = $1('#cart-float'); if(cf && count) { cf.classList.add('has-count'); cf.setAttribute('data-count', count); }
});
})();
