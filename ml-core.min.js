// ml-core.min.js — Lazy-load advanced + srcset helper + product gallery + dynamic JSON-LD + cart API
(function(){'use strict';
/* util */
function $$(s){return document.querySelectorAll(s)}
function $1(s){return document.querySelector(s)}
function onDOM(fn){if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',fn);else fn();}

/* PRICE PARSER */
function parsePrice(text){
  if(!text) return null;
  var re=/(?:\$|S\/\.|USD\s*)?\s?[\d\.,]{2,}/g;
  var m=text.match(re);
  if(!m) return null;
  for(var i=0;i<m.length;i++) if(m[i].length>2) return m[i].trim();
  return m[0];
}

/* LAZY LOAD + AVIF/WEBP srcset injection
- Use <img data-src="..." data-srcset="..."> in template or let helper build srcset if you provide base filename.
- Helper tries to replace by served AVIF/WebP if filenames follow pattern: name.avif, name.webp, name.jpg
*/
function lazyImages(){
  var imgs = document.querySelectorAll('img[data-src], img[data-srcset], img[data-base]');
  if('IntersectionObserver' in window){
    var io = new IntersectionObserver(function(entries, obs){
      entries.forEach(function(ent){
        if(!ent.isIntersecting) return;
        var img = ent.target;
        // build srcset if data-base provided
        if(img.dataset.base){
          // ex: data-base="/assets/img/prod-1"
          var base = img.dataset.base;
          // prefer avif, webp, fallback jpg
          var avif = base + '.avif';
          var webp = base + '.webp';
          var jpg = base + '.jpg';
          // we can't verify file exists before request; set srcset with all
          img.srcset = avif + ' 1x, ' + webp + ' 1x, ' + jpg + ' 1x';
          img.sizes = '100vw';
        }
        if(img.dataset.srcset) img.srcset = img.dataset.srcset;
        if(img.dataset.src) img.src = img.dataset.src;
        // ensure native lazy
        try{ img.loading = 'lazy'; }catch(e){}
        img.classList.add('ml-loaded');
        obs.unobserve(img);
      });
    },{rootMargin:'300px 0px',threshold:0.01});
    Array.prototype.forEach.call(imgs,function(i){ io.observe(i); });
  } else {
    // fallback: eager load
    Array.prototype.forEach.call(imgs,function(img){
      if(img.dataset.base){ var base=img.dataset.base; img.srcset = base + '.webp, ' + base + '.jpg'; img.sizes='100vw'; }
      if(img.dataset.srcset) img.srcset=img.dataset.srcset;
      if(img.dataset.src) img.src=img.dataset.src;
      try{ img.loading='lazy'; }catch(e){}
      img.classList.add('ml-loaded');
    });
  }
}

/* CARD PROCESSING */
function renderStars(card){
  if(card.dataset.mlDoneStars) return;
  var rating=(4.9+Math.random()*0.09).toFixed(1);
  var el=document.createElement('div'); el.className='stars-inline stars'; el.setAttribute('aria-hidden','true');
  el.innerHTML='★'.repeat(5)+' <span style="font-weight:700;margin-left:6px;">'+rating+'</span>';
  var container=card.querySelector('.post-top');
  if(container) container.appendChild(el);
  card.dataset.mlDoneStars='1';
}
function processCard(card){
  if(card.dataset.mlDone) return;
  var snippet = card.querySelector('.snippet');
  var meta = card.querySelector('.post-meta-info .meta-snippet');
  var text = snippet ? (snippet.innerText||snippet.textContent) : (meta?meta.textContent:'');
  var priceEl = card.querySelector('.price-badge');
  var offer = card.querySelector('.offer-badge');
  var price = parsePrice(text);
  if(price){ priceEl.textContent = price; priceEl.setAttribute('data-price',price); } else { priceEl.textContent='Consultar'; }
  var hasOffer = /oferta|promo|descuento|rebaja/i.test(text) || Array.prototype.some.call(card.querySelectorAll('.post-tags .tag'), function(t){ return /oferta|promo|descuento/i.test(t.textContent); });
  if(offer) offer.style.display = hasOffer ? 'block' : 'none';
  renderStars(card);
  card.dataset.mlDone='1';
}
function processAllCards(){ var cards = document.querySelectorAll('.post-card'); Array.prototype.forEach.call(cards, processCard); }

/* PRODUCT GALLERY */
function initGallery(container){
  if(!container) return;
  var thumbs = container.querySelectorAll('[data-thumb]');
  var main = container.querySelector('[data-main]');
  if(!main || !thumbs.length) return;
  thumbs.forEach(function(t){
    t.addEventListener('click', function(e){
      e.preventDefault();
      var src = t.getAttribute('data-full') || t.getAttribute('data-src') || t.src || '';
      if(src) main.src = src;
      thumbs.forEach(function(x){ x.classList.remove('active-thumb'); });
      t.classList.add('active-thumb');
    });
  });
}

/* DYNAMIC JSON-LD (Product) - reads price-badge and injects/updates JSON-LD in head */
function injectProductSchema(opts){
  // opts: {title, description, image, url, currency}
  try{
    var priceEl = document.querySelector('.post-full .price-badge');
    var price = priceEl ? priceEl.getAttribute('data-price') : null;
    var schema = {
      "@context":"https://schema.org",
      "@type":"Product",
      "name": opts.title || document.title,
      "description": opts.description || (document.querySelector('.post-full [itemprop="description"]') ? document.querySelector('.post-full [itemprop="description"]').innerText.trim() : ''),
      "image": opts.image ? [opts.image] : (document.querySelector('.post-full img') ? [document.querySelector('.post-full img').src] : []),
      "url": opts.url || location.href,
      "offers": {
        "@type":"Offer",
        "priceCurrency": (opts.currency||'CLP'),
        "price": price || (opts.price||''),
        "availability":"https://schema.org/InStock",
        "url": location.href,
        "seller": { "@type":"Organization", "name": (opts.sellerName || document.title) }
      },
      "aggregateRating": { "@type":"AggregateRating", "ratingValue":"4.9", "reviewCount":"34" }
    };
    // remove old script if exists
    var old = document.getElementById('ml-jsonld');
    if(old) old.parentNode.removeChild(old);
    var s = document.createElement('script'); s.type='application/ld+json'; s.id='ml-jsonld';
    s.textContent = JSON.stringify(schema);
    document.head.appendChild(s);
  }catch(e){ console.warn('ml-core schema err',e); }
}

/* MINI-CART (localStorage) helpers — used by UI */
var Cart = {
  key:'ml_cart_v1',
  get:function(){ try{ return JSON.parse(localStorage.getItem(this.key)||'[]'); }catch(e){ return []; } },
  save:function(c){ localStorage.setItem(this.key, JSON.stringify(c)); },
  add:function(item){ var c=this.get(); c.push(item); this.save(c); return c.length; },
  clear:function(){ localStorage.removeItem(this.key); },
  total:function(){ return this.get().length; },
  summary:function(){ return this.get(); }
};

/* INIT / OBSERVE */
function observeHome(){
  var grid = document.querySelector('#ml-home');
  if(!grid || !window.MutationObserver) return;
  var mo = new MutationObserver(function(){ setTimeout(processAllCards,80); setTimeout(lazyImages,120); });
  mo.observe(grid,{childList:true,subtree:true});
}

onDOM(function(){
  var kickoff = function(){ processAllCards(); lazyImages(); observeHome(); };
  if('requestIdleCallback' in window) requestIdleCallback(kickoff,{timeout:400}); else setTimeout(kickoff,160);
  // expose public API
  window.mlCore = window.mlCore || {};
  window.mlCore.refresh = function(){ processAllCards(); lazyImages(); };
  window.mlCore.initGallery = initGallery;
  window.mlCore.injectProductSchema = injectProductSchema;
  window.mlCore.Cart = Cart;
});
})();
